<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Health Check :: Quarkus Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/quarkus-tutorial/quarkus-tutorial/health.html">
    <link rel="prev" href="fault-tolerance.html">
    <link rel="next" href="metrics.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/quarkus-tutorial">Quarkus Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="quarkus-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html">Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basics</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basics.html">Basics and Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="panache.html">Hibernate with Panache</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kubernetes.html">Deploy to Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="dev-services.html">Dev Services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="spring.html">Spring Compatibility</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cloud Native</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="rest-client.html">REST Client</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="fault-tolerance.html">Fault Tolerance</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="health.html">Health Check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="metrics.html">Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security.html">Security with JWT RBAC</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">quarkus-tutorial</a></li>
    <li>Cloud Native</li>
    <li><a href="health.html">Health Check</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/quarkus-tutorial/edit/master/documentation/modules/ROOT/pages/health.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Health Check</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Health Checks are important in platforms like Kubernetes because it allows the infrastructure to be aware of the state of the application.</p>
</div>
<div class="paragraph">
<p>There are two different types of health checks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Liveness probes</strong> tell your platform if your application is running ok or not. When your liveness probe is down, your platform might restart your instance to guarantee that you have the minimum required amount of running instances in production.</p>
</li>
<li>
<p><strong>Readiness probes</strong> tell your platform if your application is <em>warm</em> enough to reply to requests in a reasonable amount of time. Java applications, for example, might need some time to warm up, so the readiness probe should be up only when it&#8217;s ready to reply to a request in a timely manner. Checks that depend on other services should be implemented as readiness probes: if a remote service is down, restarting your application won&#8217;t fix the issue.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_the_health_extension"><a class="anchor" href="#_add_the_health_extension"></a>Add the Health extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just open a new terminal window, and make sure youâ€™re at the root of your <code>tutorial-app</code> project, then run:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_maven"></a>Maven</p>
</li>
<li>
<p><a id="tabset1_quarkus-cli"></a>Quarkus CLI</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_maven">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn quarkus:add-extension -Dextension=quarkus-smallrye-health</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_quarkus-cli">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus extension add quarkus-smallrye-health</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoke_the_health_endpoint"><a class="anchor" href="#_invoke_the_health_endpoint"></a>Invoke the /health endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just by adding the Health extension you&#8217;ll have a <code>/q/health</code> endpoint providing a very trivial health check.</p>
</div>
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/q/health</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
        {
            "name": "Database connections health check",
            "status": "UP"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that since we&#8217;re using the Hibernate and database extensions, Quarkus automatically added a readiness probe checking the status of our database connections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can modify the default path by adding the following property in <code>applications.properties</code> :
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.smallrye-health.root-path=/health</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_a_custom_liveness_probe"><a class="anchor" href="#_add_a_custom_liveness_probe"></a>Add a custom liveness probe</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a new <code>LivenessProbe</code> Java class in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import org.eclipse.microprofile.health.HealthCheck;
import org.eclipse.microprofile.health.HealthCheckResponse;
import org.eclipse.microprofile.health.Liveness;

@Liveness
public class LivenessProbe implements HealthCheck {
    @Override
    public HealthCheckResponse call() {
        return HealthCheckResponse.up("I'm alive");
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_a_custom_readiness_probe"><a class="anchor" href="#_add_a_custom_readiness_probe"></a>Add a custom readiness probe</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In dev mode, all your heath checks are visible in health UI: <a href="http://localhost:8080/q/health-ui/" class="bare">http://localhost:8080/q/health-ui/</a>.</p>
</div>
<div class="paragraph">
<p>Some extensions may provide default health checks, including that the extension will automatically register its health checks.
For example, quarkus-agroal (that is used to manage Quarkus datasources) automatically registers a readiness health check that will validate each datasource.</p>
</div>
<div class="paragraph">
<p>Since the readiness of the database is already assessed just by adding those extensions, we should look into defining health checks for other dependencies that we have.
As we depend on the availability of <a href="https://fruityvice.com" class="bare">https://fruityvice.com</a>, let&#8217;s create a new <code>ReadinessProbe</code> to assess its availability prior to using it.</p>
</div>
<div class="paragraph">
<p>We will define a new Java class in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import io.smallrye.health.checks.UrlHealthCheck;
import org.eclipse.microprofile.config.inject.ConfigProperty;
import org.eclipse.microprofile.health.HealthCheck;
import org.eclipse.microprofile.health.Readiness;

import jakarta.enterprise.context.ApplicationScoped;
import jakarta.ws.rs.HttpMethod;

@ApplicationScoped
public class CustomHealthCheck {

    @ConfigProperty(name = "com.redhat.developers.FruityViceService/mp-rest/url")
    String externalURL;

    @Readiness <i class="conum" data-value="1"></i><b>(1)</b>
    HealthCheck checkURL() {
        return new UrlHealthCheck(externalURL+"/api/fruit/banana") <i class="conum" data-value="2"></i><b>(2)</b>
                .name("ExternalURL health check").requestMethod(HttpMethod.GET).statusCode(200);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the method with <code>org.eclipse.microprofile.health.Readiness</code> to signal its implementation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>UrlHealthCheck</code> checks if host is reachable using a Http URL connection.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoke_the_health_endpoint_with_custom_probes"><a class="anchor" href="#_invoke_the_health_endpoint_with_custom_probes"></a>Invoke the /health endpoint with custom probes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/health</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
        {
            "name": "I'm alive",
            "status": "UP"
        },
        {
            "name": "ExternalURL health check",
            "status": "UP",
            "data": {
                "host": "GET https://fruityvice.com/api/fruit/banana"
            }
        },
        {
            "name": "Database connections health check",
            "status": "UP"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the <code>/health</code> endpoint consolidates information from both the liveness and readiness probes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoke_the_liveness_endpoint"><a class="anchor" href="#_invoke_the_liveness_endpoint"></a>Invoke the liveness endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/health/live</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
        {
            "name": "I'm alive",
            "status": "UP"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the liveness endpoint only returns information about the liveness probes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoke_the_readiness_endpoint"><a class="anchor" href="#_invoke_the_readiness_endpoint"></a>Invoke the readiness endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/health/ready</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "UP",
    "checks": [
        {
            "name": "ExternalURL health check",
            "status": "UP",
            "data": {
                "host": "GET https://fruityvice.com/api/fruit/banana"
            }
        },
        {
            "name": "Database connections health check",
            "status": "UP"
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the readiness endpoint only returns information about the readiness probes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_health_extension_and_kubernetes"><a class="anchor" href="#_the_health_extension_and_kubernetes"></a>The Health extension and Kubernetes</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;re using the Quarkus Kubernetes extension, the liveness and readiness probes are automatically configured in your <code>Deployment</code> when you generate the Kubernetes yaml files.
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="fault-tolerance.html">Fault Tolerance</a></span>
  <span class="next"><a href="metrics.html">Metrics</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
