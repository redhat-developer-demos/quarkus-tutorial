<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chains and Memory :: Quarkus Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/quarkus-tutorial/quarkus-tutorial/18_chains_memory.html">
    <link rel="prev" href="17_prompts.html">
    <link rel="next" href="19_agents_tools.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/quarkus-tutorial">Quarkus Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="quarkus-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01_setup.html">Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basics</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02_basics.html">Basics and Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03_configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04_panache.html">Hibernate with Panache</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05_kubernetes.html">Deploy to Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06_dev-services.html">Dev Services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07_spring.html">Spring Compatibility</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cloud Native</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08_rest-client.html">REST Client</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09_fault-tolerance.html">Fault Tolerance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10_health.html">Health Check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="11_observability.html">Observability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12_security.html">Security with JWT RBAC</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reactive</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="14_reactive.html">Reactive with Mutiny</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="15_reactive-messaging.html">Streaming reactive messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="15_kafka-and-streams.html">Apache Kafka with Reactive Streams</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">AI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="17_prompts.html">Working with prompts</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="18_chains_memory.html">Chains and Memory</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="19_agents_tools.html">Agents/Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="20_embed_documents.html">Embedding Documents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="21_podman_ai.html">Working with Podman Desktop AI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="22_local_models.html">Working with local models</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">quarkus-tutorial</a></li>
    <li>AI</li>
    <li><a href="18_chains_memory.html">Chains and Memory</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/quarkus-tutorial/edit/master/documentation/modules/ROOT/pages/18_chains_memory.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Chains and Memory</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>So far we explored how to use prompts with LLMs, however to really leverage the power of LLMs it is essential that you
can build a conversation by referring to previous questions and answers and manage concurrent interactions.</p>
</div>
<div class="paragraph">
<p>In this section we&#8217;ll cover how we can achieve this with the LangChain4j extension in Quarkus.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_an_ai_service_with_memory"><a class="anchor" href="#_create_an_ai_service_with_memory"></a>Create an AI service with memory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s create an interface for our AI service, but with memory feature this time.</p>
</div>
<div class="paragraph">
<p>Create a new <code>AssistantWithMemory</code> Java interface in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import dev.langchain4j.service.MemoryId;
import dev.langchain4j.service.UserMessage;
import io.quarkiverse.langchain4j.RegisterAiService;

@RegisterAiService(/*chatMemoryProviderSupplier = RegisterAiService.BeanChatMemoryProviderSupplier.class*/)
public interface AssistantWithMemory {

    String chat(@MemoryId Integer id, @UserMessage String msg);

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implement_the_chatmemoryprovider"><a class="anchor" href="#_implement_the_chatmemoryprovider"></a>Implement the ChatMemoryProvider</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LangChain4j provides the interface <code>ChatMemoryProvider</code> to help us manage the memory of our conversations with the LLM.</p>
</div>
<div class="paragraph">
<p>Create a new <code>ChatMemoryBean</code> Java class in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import jakarta.annotation.PreDestroy;
import jakarta.enterprise.context.ApplicationScoped;

import dev.langchain4j.memory.ChatMemory;
import dev.langchain4j.memory.chat.ChatMemoryProvider;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;

@ApplicationScoped
public class ChatMemoryBean implements ChatMemoryProvider {

    private final Map&lt;Object, ChatMemory&gt; memories = new ConcurrentHashMap&lt;&gt;();

    @Override
    public ChatMemory get(Object memoryId) {
        return memories.computeIfAbsent(memoryId, id -&gt; MessageWindowChatMemory.builder() <i class="conum" data-value="1"></i><b>(1)</b>
                .maxMessages(20) <i class="conum" data-value="2"></i><b>(2)</b>
                .id(memoryId)
                .build());
    }

    @PreDestroy
    public void close() {
        memories.clear();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If no chat memory exists yet, create a new instance</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Retain a maximum of 20 messages</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_developer_resource"><a class="anchor" href="#_create_a_developer_resource"></a>Create a Developer resource</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s create a resource to help us write some code.</p>
</div>
<div class="paragraph">
<p>Create a new <code>DeveloperResource</code> Java class in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import static dev.langchain4j.data.message.UserMessage.userMessage;
import static dev.langchain4j.model.openai.OpenAiModelName.GPT_3_5_TURBO;

import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

import dev.langchain4j.chain.ConversationalChain;
import dev.langchain4j.data.message.AiMessage;
import dev.langchain4j.data.message.UserMessage;
import dev.langchain4j.memory.ChatMemory;
import dev.langchain4j.memory.chat.TokenWindowChatMemory;
import dev.langchain4j.model.Tokenizer;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.openai.OpenAiTokenizer;
import dev.langchain4j.model.output.Response;

@Path("/code")
public class DeveloperResource {

    @Inject
    private ChatLanguageModel model;

    @GET
    @Path("/rest")
    @Produces(MediaType.TEXT_PLAIN)
    public void createRestEndpoint() {

        Tokenizer tokenizer = new OpenAiTokenizer();
        ChatMemory chatMemory = TokenWindowChatMemory.withMaxTokens(1000, tokenizer);

        UserMessage userMessage1 = userMessage(
                "How do I write a REST endpoint in Java using Quarkus? ");
        chatMemory.add(userMessage1);

        System.out.println("[User]: " + userMessage1.contents() + System.lineSeparator());

        final Response&lt;AiMessage&gt; response1 = model.generate(chatMemory.messages());
        chatMemory.add(response1.content());

        System.out.println("[LLM]: " + response1.content().text() + System.lineSeparator());

        UserMessage userMessage2 = userMessage(
                "Create a test of the first point. " +
                        "Be short, 15 lines of code maximum.");
        chatMemory.add(userMessage2);

        System.out.println("[User]: " + userMessage2.contents() + System.lineSeparator());

        final Response&lt;AiMessage&gt; response2 = model.generate(chatMemory.messages());

        System.out.println("[LLM]: " + response2.content().text() + System.lineSeparator());

    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoke_the_endpoint"><a class="anchor" href="#_invoke_the_endpoint"></a>Invoke the endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can check your prompt implementation by pointing your browser to <a href="http://localhost:8080/code/rest" class="bare" target="_blank" rel="noopener">http://localhost:8080/code/rest</a></p>
</div>
<div class="paragraph">
<p>You can also run the following command in your terminal:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/code/rest</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result will be in the logs of your Quarkus application (ie. the terminal where you&#8217;re running the <code>quarkus dev</code> command). An example of output (it can vary on each prompt execution):</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">[User]: How do I write a REST endpoint in Java using Quarkus?

[LLM]: To create a REST endpoint in Java using Quarkus, you can follow these steps:

1. Create a new Quarkus project using the Quarkus Maven plugin or Quarkus CLI.
2. Create a new Java class for your REST endpoint. You can annotate this class with `@Path` to define the base URL path for your endpoint.
3. Add methods to your class and annotate them with `@GET`, `@POST`, `@PUT`, or `@DELETE` annotations to define the HTTP method for each endpoint.
4. Use the `@Produces` and `@Consumes` annotations to specify the content type of the responses and requests.
5. Use the `@PathParam` and `@QueryParam` annotations to capture path and query parameters in your endpoint methods.
6. Implement the logic for your endpoint methods.
7. Build and run your Quarkus project to start the application and test your REST endpoint.

Here's an example of a simple REST endpoint class in Quarkus:

```java
import javax.ws.rs.*;
import javax.ws.rs.core.MediaType;

@Path("/hello")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class HelloResource {

    @GET
    public String sayHello() {
        return "Hello, World!";
    }

    @GET
    @Path("/{name}")
    public String sayHelloTo(@PathParam("name") String name) {
        return "Hello, " + name + "!";
    }
}
```

This class defines two REST endpoints: `/hello` for saying hello to the world, and `/hello/{name}` for saying hello to a specific name. You can access these endpoints at `http://localhost:8080/hello` and `http://localhost:8080/hello/{name}` respectively.


[User]: Create a test of the first point. Be short, 15 lines of code maximum.

[LLM]: Here's an example of a simple test for the `sayHello` endpoint in Quarkus using JUnit:

```java
import io.quarkus.test.junit.QuarkusTest;
import io.restassured.RestAssured;
import org.junit.jupiter.api.Test;

import static io.restassured.RestAssured.given;
import static org.hamcrest.CoreMatchers.is;

@QuarkusTest
public class HelloResourceTest {

    @Test
    public void testSayHelloEndpoint() {
        given()
          .when().get("/hello")
          .then()
             .statusCode(200)
             .body(is("Hello, World!"));
    }
}
```

In this test, we are using the QuarkusTest annotation to run the test in the Quarkus test environment. The `testSayHelloEndpoint` method sends a GET request to the `/hello` endpoint and verifies that the response status code is 200 and that the response body is "Hello, World!".
```</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now get some help to learn a little bit about Kubernetes.</p>
</div>
<div class="paragraph">
<p>Add a new <code>generateKubernetes()</code> method to the <code>DeveloperResource</code> class:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @GET
    @Path("/k8s")
    @Produces(MediaType.TEXT_PLAIN)
    public void generateKubernetes() {

        ConversationalChain chain = ConversationalChain.builder()
                .chatLanguageModel(model)
                .build();

        String userMessage1 = "Can you give a brief explanation of Kubernetes, 3 lines max?";
        System.out.println("[User]: " + userMessage1 + System.lineSeparator());

        String answer1 = chain.execute(userMessage1);
        System.out.println("[LLM]: " + answer1 + System.lineSeparator());

        String userMessage2 = "Can you give me a YAML example to deploy an application for that?";
        System.out.println("[User]: " + userMessage2 + System.lineSeparator());

        String answer2 = chain.execute(userMessage2);
        System.out.println("[LLM]: " + answer2);

    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoke_the_endpoint_2"><a class="anchor" href="#_invoke_the_endpoint_2"></a>Invoke the endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can check your prompt implementation by pointing your browser to <a href="http://localhost:8080/code/k8s" class="bare" target="_blank" rel="noopener">http://localhost:8080/code/k8s</a></p>
</div>
<div class="paragraph">
<p>You can also run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/code/k8s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result will be onc again in your Quarkus application logs. An example of output (it can vary on each prompt execution):</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">[User]: Can you give a brief explanation of Kubernetes, 3 lines max?

[LLM]: Kubernetes is an open-source container orchestration platform that automates the deployment, scaling, and management of containerized applications. It simplifies the process of managing and coordinating large numbers of containers across multiple clusters. Kubernetes provides a scalable and efficient way to deploy and manage containerized applications in a production-ready environment.


[User]: Can you give me a YAML example to deploy an application for that?

[LLM]: Sure! Here is an example of a simple YAML file that deploys a sample application using Kubernetes:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sample-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: sample-app
  template:
    metadata:
      labels:
        app: sample-app
    spec:
      containers:
      - name: sample-app
        image: nginx:latest
        ports:
        - containerPort: 80
```

Save this YAML file as `sample-app-deployment.yaml` and apply it using the `kubectl apply -f sample-app-deployment.yaml` command to deploy the sample application with 3 replicas running NGINX.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_index_a_conversation"><a class="anchor" href="#_how_to_index_a_conversation"></a>How to index a conversation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can use the LangChain4j extension to index a conversation so we can reuse it.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s inject an instance of the AssistantWithMemory class and add a new <code>guessWho()</code> method to our <code>DeveloperResource</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Inject
    AssistantWithMemory assistant;

    @GET
    @Path("/guess")
    @Produces(MediaType.TEXT_PLAIN)
    public void guessWho() {

        System.out.println(assistant.chat(1, "Hello, my name is Klaus, and I'm a Doctor"));

        System.out.println(assistant.chat(2, "Hello, my name is Francine, and I'm a Lawyer"));

        System.out.println(assistant.chat(1, "What is my name?"));

        System.out.println(assistant.chat(2, "What is my profession?"));

    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoke_the_endpoint_3"><a class="anchor" href="#_invoke_the_endpoint_3"></a>Invoke the endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can check your implementation by pointing your browser to <a href="http://localhost:8080/code/guess" class="bare" target="_blank" rel="noopener">http://localhost:8080/code/guess</a></p>
</div>
<div class="paragraph">
<p>You can also run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/code/guess</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result will be at your Quarkus terminal. An example of output (it can vary on each prompt execution):</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Hello Klaus, it's nice to meet you. What type of doctor are you?
Hello Francine, nice to meet you! How can I assist you today?
Your name is Klaus.
Your profession is a Lawyer. You are legally trained and licensed to represent clients in legal matters.</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You might be confused by the responses (ie. Klaus is not a lawyer but a doctor). Take a close look at the IDs of our calls to the assistant. Do you notice that the last question was in fact directed to Francine with ID=2? We were indeed able to maintain 2 separate and concurrent conversations with the LLM!
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="17_prompts.html">Working with prompts</a></span>
  <span class="next"><a href="19_agents_tools.html">Agents/Tools</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
